# Exploitation Phase

## I. Mục tiêu:
- Ở giai đoạn Reconnaissance chúng ta đã thu thập được các thông tin sau:
  - Các IP malicious thực hiện tấn công:
    - `40.80.148.42`
    - `23.22.63.114`
      
  - Địa chỉ IP của webserver:
    - `192.168.250.70`
      
  - CMS mà webserver sử dụng:
    - Joomla
      
  - Một nỗ lực tấn công brute force đến từ IP `23.22.63.114`

- Ở giai đoạn này chúng ta sẽ xem xét các khả năng tấn công brute force nhắm vào webserver và liệu attacker có thực hiện thành công không.

## II. Các bước thực hiện:

### 1. Xác định mục tiêu tấn công brute force:
- Đầu tiên, chúng ta cần xác định IP `23.22.63.114` thực hiện tấn công brute force nhắm vào trang nào. Có phải là trang admin của CMS Joomla hay không?

**Thực hiện truy vấn:**
```splunk
index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST src_ip="23.22.63.114"
```
- **Giải thích:** Truy vấn tìm kiếm các traffic với method `POST` từ `src_ip="23.22.63.114"` đến `dest_ip="192.168.250.70"` của webserver.
- **Kết quả:** Kiểm tra trong các trường `uri`, `uri_path`, ta thấy chỉ có duy nhất một URI `/joomla/administrator/index.php` mà IP `23.22.63.114` đã truy cập đến thông qua method `POST`.

![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/1.png)

- **Giao diện login Jooomla**
![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/2.png)

### 2. Xác định thông tin brute force:
- Attacker tiến hành tấn công brute force thử nhiều username, password khác nhau đối với trang quản trị Joomla. Do đó chúng ta sẽ đào sâu vào các giá trị trong trường `form_data` để xem liệu attacker đã brute force thành công hay chưa.

**Thực hiện truy vấn:**
```splunk
index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST uri="/joomla/administrator/index.php" | table _time uri src_ip dest_ip form_data
```
- **Giải thích:**
  - Tìm kiếm các traffic đến webserver có IP `192.168.250.70`, qua URI `/joomla/administrator/index.php` với method `POST`.
  - Lập bảng với các cột `_time`, `uri`, `src_ip`, `dest_ip`, `form_data`.

- **Kết quả:**
  - Tìm thấy rất nhiều trường username với giá trị duy nhất là `admin` và rất nhiều trường passwd với nhiều giá trị khác nhau đến từ IP `23.22.63.114`.

![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/3.png)

### 3. Phát hiện công cụ brute force:
- Kiểm tra cột `_time` trong bảng trên, khoảng cách thời gian giữa các lần brute force là rất ngắn, attacker đang sử dụng một tool tự động để thực hiện tấn công brute force. 

**Truy vấn:**
```splunk
index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST uri="/joomla/administrator/index.php"
```
- **Kiểm tra trong trường `http_user_agent`**, ta có thể thấy `Python-urllib/2.7`, đây là một tập lệnh Python để tự động tấn công brute force.

![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/4.png)

### 4. Trích xuất password bằng Regex:
**Thực hiện truy vấn:**
```splunk
index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST form_data=*username*passwd* | rex field=form_data "username=(?<username>\w+).*passwd=(?<passwd>\w+)" | table src_ip uri username passwd
```
- **Giải thích truy vấn:**
  - Tìm kiếm traffic đến webserver `192.168.250.70`, qua URI `/joomla/administrator/index.php` với method `POST`.
  - Trích xuất thông tin `username` và `password` từ trường `form_data` bằng Regex.
  - Lập bảng với các cột `src_ip`, `uri`, `username`, `passwd`.

- **Kết quả:** Trích xuất được tất cả các trường `username` và `password` mà IP `23.22.63.114` đang cố gắng brute force.

![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/5.png)

### 5. Xác định IP login thành công:
- Ở dòng thứ hai trong bảng trên, IP `40.80.148.42` truy cập URI `/joomla/administrator/index.php` và thực hiện login với `username=admin` và `password=batman`. Để chắc chắn cần thêm thông tin trường `http_user_agent`.

**Thực hiện truy vấn:**
```splunk
index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST form_data=*username*passwd* | rex field=form_data "username=(?<username>\w+).*passwd=(?<passwd>\w+)" | table src_ip uri http_user_agent username passwd
```
- **Kết quả:** Attacker sử dụng IP `40.80.148.42` để login thành công bằng trình duyệt Mozilla với `username=admin` và `password=batman`.

![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/6.png)

## III. Trả lời các câu hỏi:

1. **What was the URI which got multiple brute force attempts?**
   - `/joomla/administrator/index.php`
   - **Giải thích:** 
      - **Truy vấn**
        ```splunk
        index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST src_ip="23.22.63.114"
        ```
  - Kiểm tra trong trường “uri” ta có thể thấy uri `“/joomla/administrator/index.php”`
![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/1.png)

2. **Against which username was the brute force attempt made?**
   - `admin`
   - **Giải thích:**
   - **Truy vấn**
          ```splunk
          index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST uri="/joomla/administrator/index.php" | table _time uri src_ip dest_ip form_data
          ```
   - Từ bảng dữ liệu chúng ta chỉ thấy duy nhất username `admin`
![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/3.png)

3. **What was the correct password for admin access to the content management system?**
   - `batman`
   - **Giải thích:**
     - **Chúng ta có thể thực hiện truy vấn sau để kiểm tra “batman” có phải là password đúng không?**
        ```splunk
        index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST uri=/joomla/Administrator/index.php status=200 |rex field=form_data "username=(?<username>admin).*passwd=(?<password>\batman)" |stats count by src_ip
        ```
    - Nếu password “batman” đúng thì status code là 200
![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/7.png)

4. **How many unique passwords were attempted in the brute force attempt?**
   - `412`
   - **Giải thích:**
     - **Để đếm số lượng password khác nhau sử dụng truy vấn sau:**
       ```splunk
       index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST uri=/joomla/Administrator/index.php status=200 |rex field=form_data "username=(?<username>admin).*passwd=(?<password>\batman)" |stats count by src_ip
       ```
    - Truy vấn sử dụng “dedup password” để loại bỏ các dòng trùng lặp trong kết quả theo trường password
![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/8.png)

5. **What IP address is likely attempting a brute force password attack?**
   - `23.22.63.114`
   - **Truy vấn:**
     ```splunk
     index=botsv1 sourcetype=stream:http src_ip=23.22.63.114 dest_ip="192.168.250.70" http_method=POST uri_path="/joomla/administrator/index.php"
     ```
   - Kiểm tra trong trường form_data thấy rất nhiều request post username và passwod.
![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/9.png)

6. **After finding the correct password, which IP did the attacker use to log in to the admin panel?**
   - `40.80.148.42`
   - **Truy vấn:**
     ```splunk
     index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST form_data=*username*passwd* | rex field=form_data "username=(?<username>\w+).*passwd=(?<passwd>\w+)" | table src_ip uri http_user_agent username passwd
     ```
   - Attacker đã sử dụng IP “40.80.148.42” để login vào trang quản trị admin với password đúng “batman” bằng trình duyệt Mozila
![Hình ảnh](https://github.com/PhucsS24/Incident-handling-with-Splunk/blob/main/2.%20Exploitation%20Phase/images/6.png)

## IV. Kết luận:
- **Uri bị tấn công brute force:** `/joomla/administrator/index.php`
- **Username bị tấn công brute force:** `admin`
- **Mật khẩu chính xác:** `batman`
- **Số lượng password khác nhau:** `412`
- **IP brute force:** `23.22.63.114`
- **IP login thành công:** `40.80.148.42`
- **Tool brute force:** `Python-urllib/2.7`
